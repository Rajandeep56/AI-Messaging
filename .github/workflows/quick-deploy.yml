name: Quick Deploy Existing Build

on:
  push:
    branches: [ main, master ]
    paths:
      - 'chatter/**'
  workflow_dispatch:

jobs:
  quick-deploy:
    runs-on: ubuntu-latest
    environment: chatter
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Firebase CLI
      run: npm install -g firebase-tools
      
    - name: Download Existing Build
      run: |
        cd chatter
        # Download the existing finished AAB build (saves 1 hour!)
        curl -L -o app-release.aab "https://expo.dev/artifacts/eas/tda4pib5cJeEoAv4PG6JgX.aab"
        echo "‚úÖ Downloaded existing build - no waiting for new build!"
        
    - name: Setup Firebase
      run: |
        cd chatter
        echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' > firebase-service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS="firebase-service-account.json"
        firebase use ai-msging
      env:
        FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        
    - name: Deploy to Firebase App Distribution
      run: |
        cd chatter
        echo "üöÄ Deploying existing build to Firebase App Distribution..."
        
        # First, ensure testers are added
        firebase appdistribution:testers:add kaurdeep9073@gmail.com || echo "Tester already exists"
        
        # Deploy using the method that worked - APK to individual testers
        # Convert AAB to APK or use existing APK
        if [ -f "app-release.apk" ]; then
          echo "Using existing APK file..."
        else
          echo "Converting AAB to APK or downloading latest APK..."
          # Try to get the latest APK build
          BUILD_URL=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].artifacts.buildUrl')
          curl -L -o app-release.apk "$BUILD_URL"
        fi
        
        firebase appdistribution:distribute app-release.apk \
          --app 1:965784009156:android:de800004fd88a35b410c91 \
          --testers kaurdeep9073@gmail.com \
          --release-notes "Chatter App v1.0.0 - Quick Deploy from GitHub Actions"
      env:
        FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        
    - name: Deploy Web Version
      run: |
        cd chatter
        npm ci
        npm run build:web
        firebase deploy --only hosting
        
    - name: Success Message
      run: |
        echo "üéâ Quick deployment completed!"
        echo "üì± Android app deployed to Firebase App Distribution"
        echo "üåê Web version deployed to Firebase Hosting"
        echo "‚è±Ô∏è  Total time: ~2 minutes (vs 1+ hour for new build)"
        echo "üìß Testers will receive email invitations" 